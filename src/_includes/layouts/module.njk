{% extends "layouts/base.njk" %}
{% import "macros/ui.njk" as ui %}

{% block content %}
  {{ content | safe }}

  {% if moduleId %}
  <div class="module__completion-container">
    <hr class="portal__divider">
    <button id="btn-complete-module" class="module__complete-btn-large" disabled>
      <i class="fa-regular fa-square"></i>
      <span>Concluir Módulo</span>
    </button>
  </div>
  {% endif %}
{% endblock %}

{% block aside %}
  <aside class="portal__aside portal__aside--sticky" aria-label="Navegação do módulo">
        {% if asideTopButton %}
        <div class="aside__top-button">
          {{ ui.button(
            href=asideTopButton.href,
            text=asideTopButton.text,
            variant=asideTopButton.variant or 'nav',
            icon=asideTopButton.icon or '',
            title=asideTopButton.title or ''
          ) }}
        </div>
        {% endif %}

        <!-- Navegação do Módulo (Links para seções com IDs específicos) -->
        <nav class="module-nav" aria-label="Seções do módulo">
          <h2 class="module-nav__title">{{ moduleTitle or 'Módulo' }}</h2>
          <ul class="module-nav__list">
            {% if moduleHasExplanation %}
            <li><a href="#explicacao" class="module-nav__link"><i class="fa-solid fa-book" aria-hidden="true"></i> Explicação</a></li>
            {% endif %}
            {% if moduleHasExercises %}
            <li><a href="#exercicios" class="module-nav__link"><i class="fa-solid fa-pen" aria-hidden="true"></i> Exercícios</a></li>
            {% endif %}
            {% if moduleHasChallenges %}
            <li><a href="#desafios" class="module-nav__link"><i class="fa-solid fa-bolt" aria-hidden="true"></i> Desafios</a></li>
            {% endif %}
          </ul>
        </nav>

        <!-- Checklist do Módulo -->
        {% if moduleChecklist %}
        {{ ui.checklist(moduleChecklist) }}
        {% endif %}

        <!-- Info -->
        <section class="module-info">
          <h2 class="module-info__title">Seu progresso</h2>
          <div class="module-progress-mini">
            <div class="module-progress-mini__bar">
              <div class="module-progress-mini__fill" id="module-progress-bar" style="width: 0%"></div>
            </div>
            <p class="module-progress-mini__text"><span id="module-progress-text">0</span>% completo</p>
          </div>
        </section>
  </aside>
{% endblock %}

{% block scripts %}
  <script>
    // Configuração para o script externo
    window.moduleData = {
      moduleId: "{{ moduleId }}",
      filePathStem: "{{ page.filePathStem }}"
    };

    // Função global necessária para o botão de conclusão interagir com o Tracker
    window.toggleCompleteModule = function() {
      const tracker = window.progressTracker;
      const id = '{{ moduleId }}';
      if (!id || !tracker) return;

      const isComplete = tracker.isComplete(id);

      if (isComplete) {
        // Desmarcar
        const progress = tracker.getProgress();
        delete progress[id];
        localStorage.setItem(tracker.storageKey, JSON.stringify(progress));
        tracker.triggerUpdateEvent();
      } else {
        // Marcar
        tracker.markComplete(id);
      }
      // A atualização visual do botão é tratada pelo listener 'progressUpdated' ou pelo script module-logic.js
    };
  </script>
  <script src="{{ '/js/module-logic.js' | url }}"></script>
{% endblock %}