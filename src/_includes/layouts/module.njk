{% extends "layouts/base.njk" %}
{% import "macros/ui.njk" as ui %}

{% block content %}
  {{ content | safe }}

  {% if moduleId %}
  <div class="module__completion-container">
    <hr class="portal__divider">
    <button id="btn-complete-module" class="module__complete-btn-large" disabled onclick="toggleCompleteModule()">
      <i class="fa-regular fa-square"></i>
      <span>Concluir Módulo</span>
    </button>
  </div>
  {% endif %}
{% endblock %}

{% block aside %}
  <aside class="portal__aside portal__aside--sticky" aria-label="Navegação do módulo">
        {% if asideTopButton %}
        <div class="aside__top-button">
          {{ ui.button(
            href=asideTopButton.href,
            text=asideTopButton.text,
            variant=asideTopButton.variant or 'nav',
            icon=asideTopButton.icon or '',
            title=asideTopButton.title or ''
          ) }}
        </div>
        {% endif %}

        <!-- Navegação do Módulo (Links para seções com IDs específicos) -->
        <nav class="module-nav" aria-label="Seções do módulo">
          <h2 class="module-nav__title">{{ moduleTitle or 'Módulo' }}</h2>
          <ul class="module-nav__list">
            {% if moduleHasExplanation %}
            <li><a href="#explicacao" class="module-nav__link"><i class="fa-solid fa-book" aria-hidden="true"></i> Explicação</a></li>
            {% endif %}
            {% if moduleHasExercises %}
            <li><a href="#exercicios" class="module-nav__link"><i class="fa-solid fa-pen" aria-hidden="true"></i> Exercícios</a></li>
            {% endif %}
            {% if moduleHasChallenges %}
            <li><a href="#desafios" class="module-nav__link"><i class="fa-solid fa-bolt" aria-hidden="true"></i> Desafios</a></li>
            {% endif %}
          </ul>
        </nav>

        <!-- Checklist do Módulo -->
        {% if moduleChecklist %}
        {{ ui.checklist(moduleChecklist) }}
        {% endif %}

        <!-- Info -->
        <section class="module-info">
          <h2 class="module-info__title">Seu progresso</h2>
          <div class="module-progress-mini">
            <div class="module-progress-mini__bar">
              <div class="module-progress-mini__fill" id="module-progress-bar" style="width: 0%"></div>
            </div>
            <p class="module-progress-mini__text"><span id="module-progress-text">0</span>% completo</p>
          </div>
        </section>
  </aside>
{% endblock %}

{% block scripts %}
  <script>
      // Atualizar barra de progresso do módulo
      function updateModuleProgress() {
        const checklist = document.querySelectorAll('.module-checklist__item input[type="checkbox"]');
        if (checklist.length === 0) return;
        
        const checked = document.querySelectorAll('.module-checklist__item input[type="checkbox"]:checked').length;
        const percentage = Math.round((checked / checklist.length) * 100);
        
        const progressBar = document.getElementById('module-progress-bar');
        const progressText = document.getElementById('module-progress-text');
        const checklistCount = document.getElementById('checklist-count');
        
        if (checklistCount) checklistCount.textContent = checked;
        
        if (progressBar) progressBar.style.width = percentage + '%';
        if (progressText) progressText.textContent = percentage;
        
        // Atualizar estado do botão de conclusão
        const completeBtn = document.getElementById('btn-complete-module');
        if (completeBtn) {
          // Habilita apenas se 100% completo
          completeBtn.disabled = (percentage < 100);
          updateCompleteButtonVisuals(); // Garante que o visual (check/uncheck) esteja correto
        }

        // Salvar no localStorage
        const moduleId = '{{ page.filePathStem }}';
        localStorage.setItem(`module-progress-${moduleId}`, JSON.stringify({
          checklist: Array.from(checklist).map(cb => cb.checked),
          percentage: percentage,
          updatedAt: new Date().toISOString()
        }));
      }

      // Lógica do Botão Concluir (Sincronizado com Tracker Global)
      function toggleCompleteModule() {
        const tracker = window.progressTracker;
        const id = '{{ moduleId }}';
        if (!id || !tracker) return;

        const isComplete = tracker.isComplete(id);

        if (isComplete) {
          // Desmarcar (remover do localStorage global)
          const progress = tracker.getProgress();
          delete progress[id];
          localStorage.setItem(tracker.storageKey, JSON.stringify(progress));
          tracker.triggerUpdateEvent();
        } else {
          // Marcar como concluído
          tracker.markComplete(id);
          
          // Efeito visual simples (Confetti poderia ser adicionado aqui se desejado)
        }
        updateCompleteButtonVisuals();
      }

      function updateCompleteButtonVisuals() {
        const tracker = window.progressTracker;
        const id = '{{ moduleId }}';
        const btn = document.getElementById('btn-complete-module');
        
        if (!btn || !id || !tracker) return;

        const isComplete = tracker.isComplete(id);
        const icon = btn.querySelector('i');
        const span = btn.querySelector('span');

        if (isComplete) {
          icon.className = 'fa-solid fa-square-check';
          span.textContent = 'Módulo Concluído!';
        } else {
          icon.className = 'fa-regular fa-square';
          span.textContent = 'Concluir Módulo';
        }
      }

      // Inicializar checklist ao carregar
      document.addEventListener('DOMContentLoaded', function() {
        // Carregar progresso salvo
        const moduleId = '{{ page.filePathStem }}';
        const saved = localStorage.getItem(`module-progress-${moduleId}`);
        
        if (saved) {
          const data = JSON.parse(saved);
          const checklist = document.querySelectorAll('.module-checklist__item input[type="checkbox"]');
          checklist.forEach((cb, idx) => {
            cb.checked = data.checklist[idx] || false;
          });
        }
        
        updateModuleProgress();
        
        // Listener para mudanças no checklist
        document.querySelectorAll('.module-checklist__item input[type="checkbox"]').forEach(cb => {
          cb.addEventListener('change', updateModuleProgress);
        });

        // Verificar estado inicial do botão global
        updateCompleteButtonVisuals();
      });
  </script>
{% endblock %}